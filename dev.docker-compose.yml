services:
  postgres:
    image: postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - 5432:5432
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -d postgres -U postgres']
      start_period: 20s
      interval: 30s
      retries: 5
      timeout: 5s
    volumes:
      - delegator-dev:/var/lib/postgresql/data

  # When using the mock server this can be helpful to paste into the form to create a valid token with claims etc.
  # {
  #  "email": "my@mail.com",
  #  "family_name": "Munify",
  #  "given_name": "Delegator Jr.",
  #  "preferred_username": "delegatoruser_123",
  #  "locale": "de",
  #  "urn:zitadel:iam:org:project:275671427955294244:roles": {"admin": {}}
  # }
  oidc-server-mock:
    image: ghcr.io/soluto/oidc-server-mock:latest
    ports:
      - '4011:80'
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      SERVER_OPTIONS_INLINE: |
        {
          "AccessTokenJwtType": "JWT",
          "Discovery": {
            "ShowKeySet": true
          },
          "Authentication": {
            "CookieSameSiteMode": "Lax",
            "CheckSessionCookieSameSiteMode": "Lax"
          }
        }
      LOGIN_OPTIONS_INLINE: |
        {
          "AllowRememberLogin": true
        }
      LOGOUT_OPTIONS_INLINE: |
        {
          "AutomaticRedirectAfterSignOut": true
        }
      API_SCOPES_INLINE: |
        - Name: some-app-scope-1
        - Name: some-app-scope-2
      API_RESOURCES_INLINE: |
        - Name: some-app
          Scopes:
            - some-app-scope-1
            - some-app-scope-2
      USERS_CONFIGURATION_INLINE: |
        [
          {
            "SubjectId":"1",
            "Username":"delegatoruser_123",
            "Password":"pwd",
            "Claims": [
              {
                "Type": "family_name",
                "Value": "Tailor",
                "ValueType": "string"
              },
              {
                "Type": "given_name",
                "Value": "Sam",
                "ValueType": "string"
              },
              {
                "Type": "email",
                "Value": "sam.tailor@gmail.com",
                "ValueType": "string"
              },
              {
                "Type": "preferred_username",
                "Value": "samtailor1",
                "ValueType": "string"
              },
              {
                "Type": "locale",
                "Value": "de",
                "ValueType": "string"
              },
              {
                "Type": "urn:zitadel:iam:org:project:275671427955294244:roles",
                "Value": "{\"admin\": {}}",
                "ValueType": "json"
              }
            ]
          }
        ]
      CLIENTS_CONFIGURATION_PATH: /tmp/config/mock-oidc-clients-config.json
      ASPNET_SERVICES_OPTIONS_INLINE: |
        { 
          "ForwardedHeadersOptions": { 
            "ForwardedHeaders" : "All"
          }
        }
    volumes:
      - ./mock-oidc-clients-config.json:/tmp/config/mock-oidc-clients-config.json:ro

  # app:
  #   image: munifydelegator
  #   depends_on:
  #     - postgres
  #   network_mode: host
  #   environment:
  #     - PORT=3000
  #     - DATABASE_URL=postgres://postgres:postgres@localhost:5432/postgres

  #     - PUBLIC_OIDC_AUTHORITY=http://localhost:8080
  #     # - PUBLIC_OIDC_AUTHORITY=https://guard.munify.cloud

  #     - PUBLIC_OIDC_CLIENT_ID=delegator
  #     # - PUBLIC_OIDC_CLIENT_ID=275671515582758948@dev

  #     - SECRET=123

  # prisma_studio:
  #   image: timothyjmiller/prisma-studio
  #   restart: unless-stopped
  #   ports:
  #     - 5555:5555
  #   depends_on:
  #     - postgres

  #   environment:
  #     PROJECT_NAME: 'MUNify DELEGATOR'
  #     POSTGRES_URL: postgres://postgres:postgres@postgres:5432/postgres
  #     PRISMA_STUDIO_PORT: 5555
  #     POSTGRES_PATH: /postgres

volumes:
  delegator-dev:
